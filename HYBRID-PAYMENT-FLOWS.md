# Hybrid Payment System - Flow Diagrams

**Visual Guide to Payment Flows**  
**Version:** 2.0  
**Last Updated:** October 13, 2025

---

## Table of Contents

1. [Complete System Flow](#complete-system-flow)
2. [Stripe Card Payment Flow](#stripe-card-payment-flow)
3. [PayDunya Mobile Money Flow](#paydunya-mobile-money-flow)
4. [FX Conversion Flow](#fx-conversion-flow)
5. [Webhook Processing Flow](#webhook-processing-flow)
6. [Ticket Generation Flow](#ticket-generation-flow)
7. [Error Recovery Flow](#error-recovery-flow)

---

## Complete System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER JOURNEY                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Browse Events  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Select Tickets  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ View Checkout   â”‚
                    â”‚ (Total in XOF)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Select Payment Method         â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                           â”‚
                â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Mobile Money    â”‚        â”‚   Credit Card    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚
                â”‚                           â”‚
                â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PayDunya Flow   â”‚        â”‚   Stripe Flow    â”‚
    â”‚  (See below)     â”‚        â”‚   (See below)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Payment Success â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Tickets Created â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Email Sent      â”‚
                    â”‚ (Confirmation)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  User Happy! ğŸ‰ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Stripe Card Payment Flow

### Detailed Step-by-Step

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STRIPE CARD PAYMENT                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: User Enters Card Details
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: StripePaymentForm.tsx                 â”‚
â”‚                                                 â”‚
â”‚  [Card Number Input] (Stripe Elements)         â”‚
â”‚  [Expiry Date]       (PCI Compliant)           â”‚
â”‚  [CVV]               (Never touches our server)â”‚
â”‚                                                 â”‚
â”‚  Display: 5 000 XOF                            â”‚
â”‚  Charge:  $8.86 USD                            â”‚
â”‚  Rate:    1 USD = 574 XOF                      â”‚
â”‚                                                 â”‚
â”‚  [Pay Button]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ User clicks "Pay"
                    â–¼
Step 2: Create Order
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: orderService.createOrder()            â”‚
â”‚                                                 â”‚
â”‚ POST /orders                                    â”‚
â”‚ {                                               â”‚
â”‚   event_id: "uuid",                            â”‚
â”‚   ticket_quantities: {"type-1": 2},            â”‚
â”‚   total: 5000,                                 â”‚
â”‚   currency: "XOF",                             â”‚
â”‚   status: "PENDING"                            â”‚
â”‚ }                                               â”‚
â”‚                                                 â”‚
â”‚ Returns: { orderId: "uuid", success: true }    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 3: Get FX Quote (Optional)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /functions/v1/fx-quote                     â”‚
â”‚                                                 â”‚
â”‚ Request:                                        â”‚
â”‚ {                                               â”‚
â”‚   xof_amount_minor: 5000,                      â”‚
â”‚   margin_bps: 150                              â”‚
â”‚ }                                               â”‚
â”‚                                                 â”‚
â”‚ Response:                                       â”‚
â”‚ {                                               â”‚
â”‚   usd_cents: 886,                              â”‚
â”‚   fx_num: 100,                                 â”‚
â”‚   fx_den: 574,                                 â”‚
â”‚   fx_locked_at: "2025-10-13T10:30:00Z"        â”‚
â”‚ }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 4: Create Stripe PaymentIntent
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /functions/v1/create-stripe-payment        â”‚
â”‚                                                 â”‚
â”‚ Request (Advanced Mode):                        â”‚
â”‚ {                                               â”‚
â”‚   display_amount_minor: 5000,                  â”‚
â”‚   display_currency: "XOF",                     â”‚
â”‚   charge_amount_minor: 886,                    â”‚
â”‚   charge_currency: "USD",                      â”‚
â”‚   fx_num: 100,                                 â”‚
â”‚   fx_den: 574,                                 â”‚
â”‚   fx_locked_at: "2025-10-13T10:30:00Z",       â”‚
â”‚   event_id: "uuid",                            â”‚
â”‚   order_id: "uuid",                            â”‚
â”‚   user_id: "uuid"                              â”‚
â”‚ }                                               â”‚
â”‚                                                 â”‚
â”‚ Backend Actions:                                â”‚
â”‚ 1. Check idempotency                           â”‚
â”‚ 2. Create Stripe PaymentIntent (USD)          â”‚
â”‚ 3. Create payment record (both amounts)        â”‚
â”‚ 4. Return client secret                        â”‚
â”‚                                                 â”‚
â”‚ Response:                                       â”‚
â”‚ {                                               â”‚
â”‚   clientSecret: "pi_xxx_secret_xxx",          â”‚
â”‚   paymentId: "uuid",                           â”‚
â”‚   paymentToken: "stripe-token-xxx"            â”‚
â”‚ }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 5: Confirm Payment (Stripe.js)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: stripe.confirmCardPayment()           â”‚
â”‚                                                 â”‚
â”‚ stripe.confirmCardPayment(                      â”‚
â”‚   clientSecret,                                 â”‚
â”‚   {                                             â”‚
â”‚     payment_method: {                           â”‚
â”‚       card: cardElement                         â”‚
â”‚     }                                           â”‚
â”‚   }                                             â”‚
â”‚ )                                               â”‚
â”‚                                                 â”‚
â”‚ User completes 3D Secure if required           â”‚
â”‚                                                 â”‚
â”‚ Stripe processes payment                        â”‚
â”‚                                                 â”‚
â”‚ Returns:                                        â”‚
â”‚ {                                               â”‚
â”‚   paymentIntent: {                             â”‚
â”‚     status: "succeeded"                         â”‚
â”‚   }                                             â”‚
â”‚ }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ (Async - happens in parallel)
                    â–¼
Step 6: Stripe Webhook (payment_intent.succeeded)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /functions/v1/stripe-webhook               â”‚
â”‚                                                 â”‚
â”‚ 1. Verify webhook signature                    â”‚
â”‚ 2. Log webhook (idempotent by event.id)       â”‚
â”‚ 3. Find payment by PaymentIntent ID           â”‚
â”‚ 4. Check if already completed (idempotency)   â”‚
â”‚ 5. Update payment status â†’ 'completed'         â”‚
â”‚ 6. Update order status â†’ 'COMPLETED'           â”‚
â”‚ 7. Check if tickets exist                      â”‚
â”‚ 8. Create tickets if missing                   â”‚
â”‚ 9. Mark webhook as processed                   â”‚
â”‚                                                 â”‚
â”‚ Returns: { received: true }                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 7: Frontend Success
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: Navigate to /payment/success         â”‚
â”‚                                                 â”‚
â”‚ Query params:                                   â”‚
â”‚ ?order={orderId}&token={paymentToken}          â”‚
â”‚                                                 â”‚
â”‚ 1. Call verify-payment                         â”‚
â”‚ 2. Display success message                     â”‚
â”‚ 3. Show tickets                                â”‚
â”‚ 4. Show download button                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
                 SUCCESS! ğŸ‰
```

### Timeline

```
Time    Frontend                Backend                 Stripe
-----   --------                -------                 ------
0ms     User clicks "Pay"
100ms   Create order â†’
200ms                           Order saved
300ms   Get FX quote â†’
400ms                           Return quote
500ms   Create PaymentIntent â†’
600ms                           Call Stripe API â†’
700ms                                                   PaymentIntent created
800ms                           Store in DB
900ms                           Return clientSecret
1000ms  â† Receive secret
1100ms  Confirm payment â†’
2000ms                                                  Process card (3DS)
3000ms                                                  Payment succeeds
3100ms                                                  Send webhook â†’
3200ms                          â† Receive webhook
3300ms                          Update payment
3400ms                          Create tickets
3500ms  Payment succeeds
3600ms  Navigate to success
3700ms  Verify payment â†’
3800ms                          Return success
3900ms  Display tickets
```

---

## PayDunya Mobile Money Flow

### Detailed Step-by-Step

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                PAYDUNYA MOBILE MONEY PAYMENT                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: User Selects Mobile Money
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: CheckoutForm.tsx                      â”‚
â”‚                                                 â”‚
â”‚  Payment Method: [Mobile Money]                â”‚
â”‚                                                 â”‚
â”‚  Provider: [Orange Money â–¾]                    â”‚
â”‚  Phone:    +226 XX XX XX XX                    â”‚
â”‚                                                 â”‚
â”‚  Amount: 5 000 XOF                             â”‚
â”‚                                                 â”‚
â”‚  [Pay Button]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ User clicks "Pay"
                    â–¼
Step 2: Create Order
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend: orderService.createOrder()            â”‚
â”‚                                                 â”‚
â”‚ POST /orders                                    â”‚
â”‚ {                                               â”‚
â”‚   event_id: "uuid",                            â”‚
â”‚   ticket_quantities: {"type-1": 2},            â”‚
â”‚   total: 5000,                                 â”‚
â”‚   currency: "XOF",                             â”‚
â”‚   status: "PENDING"                            â”‚
â”‚ }                                               â”‚
â”‚                                                 â”‚
â”‚ Returns: { orderId: "uuid" }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 3: Create PayDunya Payment
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /functions/v1/create-payment               â”‚
â”‚                                                 â”‚
â”‚ Request:                                        â”‚
â”‚ {                                               â”‚
â”‚   idempotency_key: "payment-xxx",              â”‚
â”‚   user_id: "uuid",                             â”‚
â”‚   event_id: "uuid",                            â”‚
â”‚   order_id: "uuid",                            â”‚
â”‚   amount_major: 5000,                          â”‚
â”‚   currency: "XOF",                             â”‚
â”‚   method: "mobile_money",                      â”‚
â”‚   phone: "+226XXXXXXXX",                       â”‚
â”‚   provider: "orange-money-bf",                 â”‚
â”‚   return_url: "https://temba.com/success",    â”‚
â”‚   cancel_url: "https://temba.com/cancelled"   â”‚
â”‚ }                                               â”‚
â”‚                                                 â”‚
â”‚ Backend Actions:                                â”‚
â”‚ 1. Create payment record (XOF)                 â”‚
â”‚ 2. Call PayDunya API                           â”‚
â”‚ 3. Get payment URL                             â”‚
â”‚                                                 â”‚
â”‚ Response:                                       â”‚
â”‚ {                                               â”‚
â”‚   success: true,                               â”‚
â”‚   payment_url: "https://app.paydunya.com/...",â”‚
â”‚   payment_token: "pdnya-token-xxx"            â”‚
â”‚ }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 4: Redirect to PayDunya
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ window.location.href = payment_url              â”‚
â”‚                                                 â”‚
â”‚ User redirected to:                            â”‚
â”‚ https://app.paydunya.com/invoice/xxx           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 5: User Completes Payment on PayDunya
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PayDunya Payment Page                           â”‚
â”‚                                                 â”‚
â”‚ 1. User enters PIN                             â”‚
â”‚ 2. Provider (Orange/Wave/Moov) confirms        â”‚
â”‚ 3. Payment processed                           â”‚
â”‚                                                 â”‚
â”‚ PayDunya redirects back:                       â”‚
â”‚ https://temba.com/success?token=xxx            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ (Async - happens in background)
                    â–¼
Step 6: PayDunya IPN Webhook
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /functions/v1/paydunya-ipn                 â”‚
â”‚                                                 â”‚
â”‚ PayDunya sends notification:                    â”‚
â”‚ {                                               â”‚
â”‚   invoice: {                                    â”‚
â”‚     token: "pdnya-token-xxx",                  â”‚
â”‚     status: "completed",                        â”‚
â”‚     total_amount: 5000                          â”‚
â”‚   }                                             â”‚
â”‚ }                                               â”‚
â”‚                                                 â”‚
â”‚ Backend Actions:                                â”‚
â”‚ 1. Validate IP/signature                       â”‚
â”‚ 2. Log webhook (idempotent)                    â”‚
â”‚ 3. Find payment by transaction_id              â”‚
â”‚ 4. Update payment â†’ 'completed'                â”‚
â”‚ 5. Update order â†’ 'COMPLETED'                  â”‚
â”‚ 6. Call admin_finalize_payment()               â”‚
â”‚ 7. Generate tickets                            â”‚
â”‚                                                 â”‚
â”‚ Returns: { received: true }                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
Step 7: User Returns to Success Page
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ https://temba.com/success?token=xxx            â”‚
â”‚                                                 â”‚
â”‚ 1. Call verify-payment with token              â”‚
â”‚ 2. Confirm payment completed                   â”‚
â”‚ 3. Display success message                     â”‚
â”‚ 4. Show tickets                                â”‚
â”‚ 5. Show download button                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
                 SUCCESS! ğŸ‰
```

### Timeline

```
Time     User Action              Backend                     PayDunya
-----    -----------              -------                     --------
0ms      Clicks "Pay"
100ms    Create order â†’
200ms                             Order saved
300ms    Create payment â†’
400ms                             Call PayDunya â†’
500ms                                                         Invoice created
600ms                             â† Payment URL
700ms    â† Redirect URL
800ms    Redirected to PayDunya â†’
10s      Enters PIN
15s                                                           Processes payment
20s                                                           Payment succeeds
21s                                                           Sends IPN â†’
22s                              â† IPN received
23s                              Process IPN
24s                              Update payment
25s                              Create tickets
26s                                                           Redirects user â†’
27s      â† Back to Temba
28s      Verify payment â†’
29s                              â† Success
30s      Display tickets
```

---

## FX Conversion Flow

### How Currency Conversion Works

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FX CONVERSION SYSTEM                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Hourly Rate Fetch (Background Job)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Cron Job (every hour)                â”‚
â”‚                                                â”‚
â”‚ Triggers: fetch-fx-rates function              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Try FX Sources (in order):                    â”‚
â”‚                                                â”‚
â”‚ 1. XE.com API (if configured)                 â”‚
â”‚    â””â”€ 403 â†’ Try next                          â”‚
â”‚                                                â”‚
â”‚ 2. ExchangeRate-API.com (free)                â”‚
â”‚    â””â”€ Success! Get USDâ†’XOF rate               â”‚
â”‚                                                â”‚
â”‚ 3. Fixer.io (if configured)                   â”‚
â”‚    â””â”€ Fallback if needed                      â”‚
â”‚                                                â”‚
â”‚ 4. Hardcoded (566 XOF/USD)                    â”‚
â”‚    â””â”€ Last resort                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validate Rate                                  â”‚
â”‚                                                â”‚
â”‚ Rate: 566.00 XOF/USD                          â”‚
â”‚                                                â”‚
â”‚ Checks:                                        â”‚
â”‚ âœ“ Is numeric                                  â”‚
â”‚ âœ“ Is positive                                 â”‚
â”‚ âœ“ In range 300-1000                           â”‚
â”‚ âœ“ Not suspiciously different from last rate  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update fx_rates Table                          â”‚
â”‚                                                â”‚
â”‚ 1. Deactivate old rates:                      â”‚
â”‚    UPDATE fx_rates                             â”‚
â”‚    SET is_active = false                       â”‚
â”‚    WHERE is_active = true                      â”‚
â”‚                                                â”‚
â”‚ 2. Insert new rate:                            â”‚
â”‚    INSERT INTO fx_rates {                      â”‚
â”‚      from_currency: 'USD',                     â”‚
â”‚      to_currency: 'XOF',                       â”‚
â”‚      rate_decimal: 566.0000,                   â”‚
â”‚      source: 'ExchangeRate-API',              â”‚
â”‚      valid_from: NOW(),                        â”‚
â”‚      valid_until: NOW() + 1 hour,             â”‚
â”‚      is_active: true                           â”‚
â”‚    }                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
                Rate Cached âœ“

Step 2: Frontend Requests Quote
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User at Checkout:                              â”‚
â”‚ Cart Total: 5000 XOF                          â”‚
â”‚                                                â”‚
â”‚ Frontend calls:                                â”‚
â”‚ stripePaymentService.getFXQuote(5000)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /functions/v1/fx-quote                    â”‚
â”‚                                                â”‚
â”‚ Request:                                       â”‚
â”‚ {                                              â”‚
â”‚   xof_amount_minor: 5000,                     â”‚
â”‚   margin_bps: 150  // 1.5%                    â”‚
â”‚ }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend: Get Active Rate                      â”‚
â”‚                                                â”‚
â”‚ SELECT * FROM fx_rates                         â”‚
â”‚ WHERE from_currency = 'USD'                    â”‚
â”‚   AND to_currency = 'XOF'                      â”‚
â”‚   AND is_active = true                         â”‚
â”‚ ORDER BY valid_from DESC                       â”‚
â”‚ LIMIT 1                                        â”‚
â”‚                                                â”‚
â”‚ Result:                                        â”‚
â”‚ {                                              â”‚
â”‚   rate_decimal: 566.0000,                      â”‚
â”‚   source: 'ExchangeRate-API'                  â”‚
â”‚ }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Apply Margin                                   â”‚
â”‚                                                â”‚
â”‚ Base Rate:     566 XOF/USD                    â”‚
â”‚ Margin:        1.5% (150 bps)                 â”‚
â”‚ Multiplier:    1.015                          â”‚
â”‚ Effective:     574 XOF/USD                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Calculate USD Amount                           â”‚
â”‚                                                â”‚
â”‚ XOF:           5000                           â”‚
â”‚ Rate:          574 XOF/USD                    â”‚
â”‚                                                â”‚
â”‚ Formula:       USD = XOF / Rate               â”‚
â”‚ USD:           5000 / 574 = 8.71 USD          â”‚
â”‚ USD Cents:     871                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return Locked Quote                            â”‚
â”‚                                                â”‚
â”‚ Response:                                      â”‚
â”‚ {                                              â”‚
â”‚   usd_cents: 871,                             â”‚
â”‚   fx_num: 100,                                â”‚
â”‚   fx_den: 574,                                â”‚
â”‚   fx_locked_at: "2025-10-13T10:30:00Z",      â”‚
â”‚   margin_bps: 150,                            â”‚
â”‚   base_xof_per_usd: 566,                      â”‚
â”‚   effective_xof_per_usd: 574,                 â”‚
â”‚   display_amount: "5 000 FCFA",              â”‚
â”‚   charge_amount: "$8.71 USD"                  â”‚
â”‚ }                                              â”‚
â”‚                                                â”‚
â”‚ Quote valid for: 5 minutes                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         Quote Returned to Frontend

Step 3: Create Payment with Quote
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â†’ create-stripe-payment               â”‚
â”‚                                                â”‚
â”‚ Passes locked quote:                           â”‚
â”‚ {                                              â”‚
â”‚   display_amount_minor: 5000,                 â”‚
â”‚   charge_amount_minor: 871,                   â”‚
â”‚   fx_num: 100,                                â”‚
â”‚   fx_den: 574,                                â”‚
â”‚   fx_locked_at: "2025-10-13T10:30:00Z"       â”‚
â”‚ }                                              â”‚
â”‚                                                â”‚
â”‚ Backend stores exact FX used in payment recordâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         Payment Created with FX Details

Step 4: Display to User
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Checkout Summary                               â”‚
â”‚                                                â”‚
â”‚ Amount (XOF):    5 000 FCFA                   â”‚
â”‚ Amount (USD):    $8.71 USD                    â”‚
â”‚ Exchange Rate:   1 USD = 574 XOF             â”‚
â”‚                                                â”‚
â”‚ [Pay $8.71 USD]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Example Calculation

```
Cart Items:
- VIP Ticket Ã— 2      = 4000 XOF
- Service Fee         = 1000 XOF
                       â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total (Display):      = 5000 XOF

FX Conversion:
Base Rate:            = 566 XOF/USD
Margin (1.5%):        = 566 Ã— 1.015 = 574 XOF/USD
USD Calculation:      = 5000 / 574 = 8.71 USD
USD Cents:            = 871 cents

Stripe Charge:
Amount:               = 871 cents
Currency:             = USD
User Sees:            = "$8.71 USD"

Database Record:
{
  display_amount_minor: 5000,
  display_currency: 'XOF',
  charge_amount_minor: 871,
  charge_currency: 'USD',
  fx_rate_numerator: 100,
  fx_rate_denominator: 574,
  fx_locked_at: '2025-10-13T10:30:00Z',
  fx_margin_bps: 150
}

Verification:
5000 XOF Ã— (100/574) = 8.71 USD âœ“
871 USD cents Ã— (574/100) = 5000.54 XOF â‰ˆ 5000 XOF âœ“
```

---

## Webhook Processing Flow

### Idempotent Webhook Handling

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBHOOK PROCESSING                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Incoming Webhook (Stripe or PayDunya)
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Verify Signature                      â”‚
â”‚                                                â”‚
â”‚ Stripe:                                        â”‚
â”‚   const sig = headers['stripe-signature']     â”‚
â”‚   stripe.webhooks.constructEvent(body, sig)   â”‚
â”‚   âœ“ Valid signature                           â”‚
â”‚                                                â”‚
â”‚ PayDunya:                                      â”‚
â”‚   const ip = headers['x-forwarded-for']       â”‚
â”‚   âœ“ IP in whitelist                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Log Webhook (Idempotent)              â”‚
â”‚                                                â”‚
â”‚ INSERT INTO payment_webhooks                   â”‚
â”‚ {                                              â”‚
â”‚   provider: 'stripe',                          â”‚
â”‚   event_type: 'payment_intent.succeeded',     â”‚
â”‚   event_key: 'evt_xxx',  // Unique!           â”‚
â”‚   raw_payload: {...},                          â”‚
â”‚   processed: false                             â”‚
â”‚ }                                              â”‚
â”‚ ON CONFLICT (event_key) DO NOTHING            â”‚
â”‚                                                â”‚
â”‚ â†’ If duplicate, upsert returns existing recordâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Find Payment                           â”‚
â”‚                                                â”‚
â”‚ Stripe:                                        â”‚
â”‚   SELECT * FROM payments                       â”‚
â”‚   WHERE stripe_payment_intent_id = 'pi_xxx'   â”‚
â”‚                                                â”‚
â”‚ PayDunya:                                      â”‚
â”‚   SELECT * FROM payments                       â”‚
â”‚   WHERE transaction_id = 'pdnya-token-xxx'    â”‚
â”‚                                                â”‚
â”‚ Result: payment record found                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Check Idempotency                     â”‚
â”‚                                                â”‚
â”‚ IF payment.status IN                           â”‚
â”‚    ('completed', 'succeeded', 'failed'):       â”‚
â”‚                                                â”‚
â”‚   Log: "Already processed"                     â”‚
â”‚   Mark webhook as processed                    â”‚
â”‚   Return: { received: true }                   â”‚
â”‚   EXIT                                         â”‚
â”‚                                                â”‚
â”‚ ELSE:                                          â”‚
â”‚   Continue processing...                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: Update Payment                         â”‚
â”‚                                                â”‚
â”‚ UPDATE payments                                â”‚
â”‚ SET                                            â”‚
â”‚   status = 'completed',                        â”‚
â”‚   completed_at = NOW(),                        â”‚
â”‚   amount_paid = charge_amount / 100            â”‚
â”‚ WHERE id = payment_id                          â”‚
â”‚                                                â”‚
â”‚ Result: 1 row updated                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: Update Order                           â”‚
â”‚                                                â”‚
â”‚ UPDATE orders                                  â”‚
â”‚ SET                                            â”‚
â”‚   status = 'COMPLETED',                        â”‚
â”‚   updated_at = NOW()                           â”‚
â”‚ WHERE id = payment.order_id                    â”‚
â”‚                                                â”‚
â”‚ Result: 1 row updated                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: Generate Tickets                      â”‚
â”‚                                                â”‚
â”‚ Stripe Webhook:                                â”‚
â”‚   â†’ Creates tickets directly in webhook       â”‚
â”‚   â†’ Checks for existing tickets first         â”‚
â”‚                                                â”‚
â”‚ PayDunya IPN:                                  â”‚
â”‚   â†’ Calls admin_finalize_payment(payment_id)  â”‚
â”‚   â†’ Function handles ticket creation          â”‚
â”‚                                                â”‚
â”‚ Both methods check for duplicates              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 8: Mark Webhook Processed                â”‚
â”‚                                                â”‚
â”‚ UPDATE payment_webhooks                        â”‚
â”‚ SET                                            â”‚
â”‚   processed = true,                            â”‚
â”‚   processed_at = NOW()                         â”‚
â”‚ WHERE event_key = 'evt_xxx'                    â”‚
â”‚                                                â”‚
â”‚ Result: Webhook marked as complete             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            Return Success
         { received: true }
```

### Retry Handling

```
Scenario: Webhook Fails (e.g., database timeout)

Attempt 1 (0 seconds):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Webhook arrives                    â”‚
â”‚ Processing fails (timeout)         â”‚
â”‚ Return 500 error                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ Stripe/PayDunya receives 500
                â”‚ Schedules retry
                â–¼

Attempt 2 (1 minute later):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Webhook arrives (same event_key)   â”‚
â”‚ Checks payment_webhooks table      â”‚
â”‚ â†’ Found existing log (not processed)â”‚
â”‚ Continue processing                 â”‚
â”‚ Success!                            â”‚
â”‚ Return 200                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         Webhook processed âœ“

Key Points:
- event_key prevents duplicate logging
- Payment status check prevents duplicate updates
- Ticket existence check prevents duplicates
- Safe to retry infinite times
```

---

## Ticket Generation Flow

### admin_finalize_payment() Function

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TICKET GENERATION (Idempotent)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Call: SELECT admin_finalize_payment('payment-uuid')

Step 1: Lock Rows
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT * FROM payments                         â”‚
â”‚ WHERE id = 'payment-uuid'                      â”‚
â”‚ FOR UPDATE                                     â”‚
â”‚                                                â”‚
â”‚ â†’ Acquires row lock                           â”‚
â”‚ â†’ Other calls wait here                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT * FROM orders                           â”‚
â”‚ WHERE id = payment.order_id                    â”‚
â”‚ FOR UPDATE                                     â”‚
â”‚                                                â”‚
â”‚ â†’ Acquires row lock                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
Step 2: Update Payment Status
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IF payment.status NOT IN                       â”‚
â”‚    ('completed', 'succeeded'):                 â”‚
â”‚                                                â”‚
â”‚   UPDATE payments                              â”‚
â”‚   SET status = 'completed',                    â”‚
â”‚       completed_at = COALESCE(completed_at, NOW())â”‚
â”‚       amount_paid = COALESCE(amount_paid, amount) â”‚
â”‚   WHERE id = payment_id                        â”‚
â”‚                                                â”‚
â”‚ ELSE:                                          â”‚
â”‚   Skip (already completed)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
Step 3: Update Order Status
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPDATE orders                                  â”‚
â”‚ SET status = 'COMPLETED'                       â”‚
â”‚ WHERE id = order_id                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
Step 4: Calculate Missing Tickets
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order ticket_quantities:                       â”‚
â”‚ {                                              â”‚
â”‚   "type-1-uuid": 2,                           â”‚
â”‚   "type-2-uuid": 1                            â”‚
â”‚ }                                              â”‚
â”‚                                                â”‚
â”‚ Query existing tickets:                        â”‚
â”‚ SELECT ticket_type_id, COUNT(*)               â”‚
â”‚ FROM tickets                                   â”‚
â”‚ WHERE order_id = 'order-uuid'                  â”‚
â”‚ GROUP BY ticket_type_id                        â”‚
â”‚                                                â”‚
â”‚ Result:                                        â”‚
â”‚ {                                              â”‚
â”‚   "type-1-uuid": 1  // Only 1 exists          â”‚
â”‚   "type-2-uuid": 0  // None exist             â”‚
â”‚ }                                              â”‚
â”‚                                                â”‚
â”‚ Calculate delta:                               â”‚
â”‚ {                                              â”‚
â”‚   "type-1-uuid": 2 - 1 = 1 to create         â”‚
â”‚   "type-2-uuid": 1 - 0 = 1 to create         â”‚
â”‚ }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
Step 5: Create Missing Tickets (Batch)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FOR EACH ticket type with missing tickets:    â”‚
â”‚                                                â”‚
â”‚ Type 1: Create 1 ticket                       â”‚
â”‚ INSERT INTO tickets (                          â”‚
â”‚   order_id, event_id, user_id,                â”‚
â”‚   ticket_type_id, status, payment_id          â”‚
â”‚ )                                              â”‚
â”‚ SELECT                                         â”‚
â”‚   'order-uuid', 'event-uuid', 'user-uuid',    â”‚
â”‚   'type-1-uuid', 'VALID', 'payment-uuid'      â”‚
â”‚ FROM generate_series(1, 1)                     â”‚
â”‚ â†’ Inserts 1 row                               â”‚
â”‚                                                â”‚
â”‚ Type 2: Create 1 ticket                       â”‚
â”‚ INSERT INTO tickets (...)                      â”‚
â”‚ SELECT ... FROM generate_series(1, 1)          â”‚
â”‚ â†’ Inserts 1 row                               â”‚
â”‚                                                â”‚
â”‚ Total created: 2 tickets                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
Step 6: Return Summary
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RETURN jsonb_build_object(                     â”‚
â”‚   'success', true,                             â”‚
â”‚   'payment_id', 'payment-uuid',               â”‚
â”‚   'order_id', 'order-uuid',                   â”‚
â”‚   'tickets_created', 2,                        â”‚
â”‚   'per_type', [                               â”‚
â”‚     {                                          â”‚
â”‚       'ticket_type_id': 'type-1-uuid',        â”‚
â”‚       'created': 1                             â”‚
â”‚     },                                         â”‚
â”‚     {                                          â”‚
â”‚       'ticket_type_id': 'type-2-uuid',        â”‚
â”‚       'created': 1                             â”‚
â”‚     }                                          â”‚
â”‚   ]                                            â”‚
â”‚ )                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         Function Complete âœ“
```

### Concurrency Safety

```
Scenario: Two webhooks arrive simultaneously

Thread 1                          Thread 2
--------                          --------
Call admin_finalize_payment()     Call admin_finalize_payment()
â†“                                 â†“
Lock payment row (acquired)       Lock payment row (waiting...)
â†“                                 â”‚
Lock order row                    â”‚
â†“                                 â”‚
Update payment                    â”‚
â†“                                 â”‚
Create 3 tickets                  â”‚
â†“                                 â”‚
Return success                    â”‚
â†“                                 â”‚
Release locks                     â”‚
                                  â†“
                                  Lock payment row (acquired)
                                  â†“
                                  Check existing tickets
                                  â†’ Found 3 tickets
                                  â†“
                                  Calculate delta: 3 - 3 = 0
                                  â†“
                                  Create 0 tickets
                                  â†“
                                  Return success (0 created)
                                  â†“
                                  Release locks

Result: Exactly 3 tickets created (no duplicates) âœ“
```

---

## Error Recovery Flow

### Stuck Payment Recovery

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ERROR RECOVERY                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Scenario: Payment succeeded but webhook failed/delayed

Step 1: Identify Stuck Payment
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT * FROM payments                         â”‚
â”‚ WHERE status = 'pending'                       â”‚
â”‚   AND created_at < NOW() - INTERVAL '1 hour'  â”‚
â”‚                                                â”‚
â”‚ Found: payment-uuid (created 2 hours ago)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
Step 2: Verify with Provider
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stripe:                                        â”‚
â”‚   const intent = await stripe.paymentIntents   â”‚
â”‚     .retrieve(payment.stripe_payment_intent_id)â”‚
â”‚   Status: 'succeeded' âœ“                        â”‚
â”‚                                                â”‚
â”‚ PayDunya:                                      â”‚
â”‚   Check PayDunya dashboard                     â”‚
â”‚   Status: 'completed' âœ“                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ Payment actually succeeded!
                â–¼
Step 3: Manual Recovery
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Option A: Trigger webhook manually             â”‚
â”‚ (if provider supports replay)                  â”‚
â”‚                                                â”‚
â”‚ Stripe:                                        â”‚
â”‚   stripe trigger payment_intent.succeeded     â”‚
â”‚                                                â”‚
â”‚ PayDunya:                                      â”‚
â”‚   Request IPN resend from dashboard           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
            OR
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Option B: Manual completion via SQL            â”‚
â”‚                                                â”‚
â”‚ -- Update payment                              â”‚
â”‚ UPDATE payments                                â”‚
â”‚ SET status = 'completed',                      â”‚
â”‚     completed_at = NOW()                       â”‚
â”‚ WHERE id = 'payment-uuid';                     â”‚
â”‚                                                â”‚
â”‚ -- Generate tickets                            â”‚
â”‚ SELECT admin_finalize_payment('payment-uuid'); â”‚
â”‚                                                â”‚
â”‚ Result:                                        â”‚
â”‚ {                                              â”‚
â”‚   success: true,                               â”‚
â”‚   tickets_created: 3                           â”‚
â”‚ }                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
         Payment Recovered âœ“
```

### Duplicate Ticket Prevention

```
Scenario: Admin accidentally calls finalization twice

Call 1:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT admin_finalize_payment(uuid)    â”‚
â”‚                                        â”‚
â”‚ Existing tickets: 0                    â”‚
â”‚ Needed: 3                              â”‚
â”‚ Created: 3                             â”‚
â”‚                                        â”‚
â”‚ Return: { tickets_created: 3 }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Call 2 (immediate retry):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SELECT admin_finalize_payment(uuid)    â”‚
â”‚                                        â”‚
â”‚ Existing tickets: 3                    â”‚
â”‚ Needed: 3                              â”‚
â”‚ Delta: 3 - 3 = 0                       â”‚
â”‚ Created: 0                             â”‚
â”‚                                        â”‚
â”‚ Return: { tickets_created: 0 }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Result: Still exactly 3 tickets âœ“
```

---

## Summary

### Key Architectural Patterns

1. **Provider Routing**: Automatic based on payment method
2. **Dual-Currency**: XOF display, USD charge (Stripe only)
3. **FX Management**: Cached rates with margin
4. **Idempotency**: Safe retries and duplicate prevention
5. **Webhook Processing**: Signature verification + idempotent handling
6. **Ticket Generation**: Concurrency-safe with delta calculation
7. **Error Recovery**: Manual tools for stuck payments

### Flow Comparison

| Aspect | Stripe (Cards) | PayDunya (Mobile Money) |
|--------|---------------|------------------------|
| Redirect | No (in-page) | Yes (external site) |
| Currency | USD | XOF |
| FX | Yes (live rates) | No |
| Completion Time | 2-5 seconds | 10-30 seconds |
| Webhook | `payment_intent.succeeded` | IPN callback |
| Ticket Creation | In webhook directly | Via `admin_finalize_payment()` |

---

*For more details, see:*
- `HYBRID-PAYMENT-ARCHITECTURE.md` - Full technical documentation
- `HYBRID-PAYMENT-QUICK-REFERENCE.md` - Developer reference guide
- `HYBRID-PAYMENT-IMPLEMENTATION-PLAN.md` - Implementation guide

*Last Updated: October 13, 2025*

